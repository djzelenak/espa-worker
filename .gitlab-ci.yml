image: docker:19.03.1

variables:
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: tcp://docker:2375
  DOCKER_DRIVER: overlay2
  GIT_SSL_NO_VERIFY: "1"

services:
  - docker:19.03.1-dind

before_script:
  - apk add make git

stages:
  - base
  - external
  - worker

base:
  stage: base
  script:
    - make build_base
    - make test_base
    - make deploy_base
  only:
    changes:
      - docker_base_os/Dockerfile.centos7
      - Makefile
      - version.txt
  tags:
    - docker
    - eros
    - lsrd

external:
  stage: external
  script:
    - make build_external
    - make test_external
    - make deploy_external
  only:
    changes:
      - docker_build_env/Dockerfile.centos7
      - version.txt
      - Makefile
      - .gitlab-ci.yml
  tags:
    - docker
    - eros
    - lsrd

#docker_science:
#  stage: science
#  script:
#    - make build_science
#    - make test_science
#    - make deploy_science
#  only:
#    changes:
#      - science/Dockerfile.centos7
#      - version.txt
#      - set_espa_versions.sh
#      - processing/*
#      - playbook/**/*
#      - setup/requirements.txt
#  tags:
#    - docker
#    - eros
#    - lsrd
