# File: espa-software.yml
# Description: Install ESPA software and system package dependencies
# Last Updated: See 'git log -p <filename>'
# Recent Changes: See 'git log -p <filename>'

# ------------ ESPA SYSTEM REQUIREMENTS ----------- #
# (espa_dependencies defined in external vars file) #
# ------------------------------------------------- #

# Install required system packages
- name: espa-software|Install ESPA required system packages
  yum:
    name: "{{ espa_dependencies }}"
    state: installed

# ---- ESPA/LSRD CUSTOM REPOS ---- #

# Install LSRD Repo
- name: espa-software|Add LSRD Custom Repo
  yum_repository:
    name: lsrd
    description: LSRD - System Package Repository
    file: lsrd
    baseurl: http://lsrdrepo.cr.usgs.gov/repo/lsrd/el6/
    gpgcheck: no
    enabled: yes
    metadata_expire: 300

# Install ESPA Repo
- name: espa-software|Add ESPA Custom Repo
  yum_repository:
    name: espa
    description: ESPA - Package Repository
    file: lsrd
    baseurl: http://lsrdrepo.cr.usgs.gov/repo/espa/el6/
    gpgcheck: no
    enabled: yes
    metadata_expire: 300

# ---------- ESPA SOFTWARE RELEASE GROUP ---------- #
# (software versions defined in external vars file) #
# ------------------------------------------------- #

# Install python from espa repo
#- name: espa-software|Install LSRD Python
#  yum:
#    name: "python-lsrd-{{ python_lsrd }}"
#    state: installed

# Install dans-gdal-scripts-espa
#- name: espa-software|Install dans-gdal-scripts-espa
#  yum:
#    name: "dans-gdal-scripts-espa-{{ dans_gdal_scripts_espa }}"
#    state: installed

# Install modtran-espa
- name: espa-software|Install modtran-espa
  yum:
    name: "modtran-espa-{{ modtran_espa }}"
    state: installed

# Build and install espa-product-formatter
- name: espa-software|Clone and checkout espa-product-formatter
  git:
    repo: 'https://github.com/USGS-EROS/espa-product-formatter.git'
    dest: /src/espa-product-formatter
    version: "{{ git_espa_product_formatter }}"

- name: espa-software|Build espa-product-formatter
  make:
    chdir: /src/espa-product-formatter
    params:
      BUILD_STATIC: yes
      ENABLE_THREADING: yes

- name: espa-software|Install espa-product-formatter
  make:
    chdir: /src/espa-product-formatter
    target: install


## Install espa-l2qa-tools
#- name: espa-software|Install espa-l2qa-tools
#  yum:
#    name: "espa-l2qa-tools-{{ espa_l2qa_tools }}"
#    state: installed
#


## Install espa-aquatic-reflectance
- name: espa-software|Clone and checkout espa-aq-refl
  git:
    accept_hostkey: yes
    ssh_opts: "-o StrictHostKeyChecking=no"
    repo: 'git@eroslab.cr.usgs.gov:lsrd/espa-aquatic-reflectance.git'
    dest: /src/espa-aq-refl
    version: "{{ git_espa_aq_refl }}"

- name: espa-software|lib3 prereqs for espa-aq-refl
  command: mkdir -p /usr/local/lib3 && cp -a /src/espa-aq-refl/src/lib3/. /usr/local/lib3/

- name: espa-software|Build espa-aq-refl
  make:
    chdir: /src/espa-aq-refl
    params:
      BUILD_STATIC: yes
      ENABLE_THREADING: yes

- name: espa-software|Install espa-aq-refl
  make:
    chdir: /src/espa-aq-refl
    target: install

- name: espa-software|Install espa-aq-refl
  yum:
    name: "espa-aq-refl-{{ espa_aq_refl }}"
    state: installed


## Install espa-surface-reflectance
- name: espa-software|Clone and checkout espa-surface-reflectance
  git:
    repo: 'https://github.com/USGS-EROS/espa-surface-reflectance.git'
    dest: /src/espa-surface-reflectance
    version: "{{ git_espa_surface_reflectance }}"

- name: espa-software|Make all espa-surface-reflectance
  make:
    chdir: /src/espa-surface-reflectance
    target: all-script

- name: espa-software|Make install espa-surface-reflectance
  make:
    chdir: /src/espa-surface-reflectance
    params:
      PREFIX: /usr/local
    target: install-script

#- name: espa-software|Install espa-surface-reflectance
#  yum:
#    name: "espa-surface-reflectance-{{ espa_surface_reflectance }}"
#    state: installed
#


## Install espa-surface-reflectance-ledaps
- name: espa-software|Clone and checkout espa-surface-reflectance-ledaps
  git:
    repo: 'https://github.com/USGS-EROS/espa-surface-reflectance.git'
    dest: /src/espa-surface-reflectance-ledaps
    version: "{{ git_espa_surface_reflectance_ledaps }}"

- name: espa-software|Make espa-surface-reflectance-ledaps
  make:
    chdir: /src/espa-surface-reflectance-ledaps
    params:
      BUILD_STATIC: yes
      ENABLE_THREADING: yes
    target: all-ledaps

- name: espa-software|Make install espa-surface-reflectance-ledaps
  make:
    chdir: /src/espa-surface-reflectance-ledaps
    params:
      PREFIX=/usr/local
    target: install-ledaps

#- name: espa-software|Install espa-surface-reflectance-ledaps
#  yum:
#    name: "espa-surface-reflectance-ledaps-{{ espa_surface_reflectance_ledaps }}"
#    state: installed
#


## Install espa-surface-reflectance-lasrc
- name: espa-software|Clone and checkout espa-surface-reflectance-lasrc
  git:
    repo: 'https://github.com/USGS-EROS/espa-surface-reflectance.git'
    dest: /src/espa-surface-reflectance-lasrc
    version: "{{ git_espa_surface_reflectance_lasrc }}"

- name: espa-software|Make espa-surface-reflectance-lasrc
  make:
    chdir: /src/espa-surface-reflectance-lasrc
    params:
      BUILD_STATIC: yes
      ENABLE_THREADING: yes
    target: all-lasrc

- name: espa-software|Make install espa-surface-reflectance-lasrc
  make:
    chdir: /src/espa-surface-reflectance-lasrc
    params:
      PREFIX: /usr/local
    target: install-lasrc

#- name: espa-software|Install espa-surface-reflectance-lasrc
#  yum:
#    name: "espa-surface-reflectance-lasrc-{{ espa_surface_reflectance_lasrc }}"
#    state: installed
#


## Install espa-surface-temperature
#- name: espa-software|Install espa-surface-temperature
#  yum:
#    name: "espa-surface-temperature-{{ espa_surface_temperature }}"
#    state: installed
#
## Install espa-surface-temperature-rit
#- name: espa-software|Install espa-surface-temperature-rit
#  yum:
#    name: "espa-surface-temperature-rit-{{ espa_surface_temperature }}"
#    state: installed
#
## Install espa-spectral-indices
#- name: espa-software|Install espa-spectral-indices
#  yum:
#    name: "espa-spectral-indices-{{ espa_spectral_indices }}"
#    state: installed
#
## Install espa-surface-water-extent
#- name: espa-software|Install espa-surface-water-extent
#  yum:
#    name: "espa-surface-water-extent-{{ espa_surface_water_extent }}"
#    state: installed
#
## Install espa-surface-water-extent-cfbwd
#- name: espa-software|Install espa-surface-water-extent-cfbwd
#  yum:
#    name: "espa-surface-water-extent-cfbwd-{{ espa_surface_water_extent_cfbwd }}"
#    state: installed
#
## Install espa-surface-water-extent-dswe
#- name: espa-software|Install espa-surface-water-extent-dswe
#  yum:
#    name: "espa-surface-water-extent-dswe-{{ espa_surface_water_extent_dswe }}"
#    state: installed
#
## Install espa-elevation
#- name: espa-software|Install espa-elevation
#  yum:
#    name: "espa-elevation-{{ espa_elevation }}"
#    state: installed
#
## Install espa-reprojection
#- name: espa-software|Install espa-reprojection
#  yum:
#    name: "espa-reprojection-{{ espa_reprojection }}"
#    state: installed
#
## Install espa-plotting
#- name: espa-software|Install espa-plotting
#  yum:
#    name: "espa-plotting-{{ espa_plotting }}"
#    state: installed
#
## ---- PIP/SETUPTOOLS INSTALLATION and UPDATE ---- #
#
## Check to see if pip exists, store answer in "pip_path"
#- name: espa-software|Check for pip
#  stat:
#    path: "/usr/local/bin/pip"
#  register: pip_path
#
## Copy pip script to system if pip did not exist
#- name: espa-software|No Pip - Copy get-pip.py for pip install
#  copy:
#    src: "espa_software/python_get-pip.py"
#    dest: "/root/get-pip.py"
#  when: pip_path.stat.exists == False
#
## Link to the opj2_decompress executable
- name: espa-software|Link opj2_decompress to opj_decompress
  file:
    src: "/usr/bin/opj2_decompress"
    dest: "/usr/bin/opj_decompress"
    state: link
#
## Install pip into LSRD Python site packages if pip did not exist
#- name: espa-software|No Pip - Install pip using LSRD Python (/usr/local/bin/python)
#  command: "/usr/local/bin/python /root/get-pip.py"
#  when: pip_path.stat.exists == False
#
## Remove get-pip.py if pip did not exist
#- name: espa-software|No Pip - Remove get-pip.py
#  file:
#    path: "/root/get-pip.py"
#    state: absent
#  when: pip_path.stat.exists == False
#
## Ensure pip and setuptools are the latest
#- name: espa-software|Ensure pip and setuptools are the latest
#  pip:
#    executable: "/usr/local/bin/pip"
#    name:
#      - pip
#      - setuptools
#    state: "latest"

# ---- ESPA PYTHON LIBRARY ---- #

# Install espa-python library
#- name: espa-software|Install espa-python-library
#  pip:
#    executable: "/usr/local/bin/pip"
#    editable: false
#    version: 1.1.0
#    name: "git+https://github.com/USGS-EROS/espa-python-library.git@v1.1.0#egg=espa"
